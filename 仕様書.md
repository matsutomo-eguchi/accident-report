æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ç§ã¯ä¸–ç•Œãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ã¨ã—ã¦ã€ã“ã®ã€Œæ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ äº‹æ•…å ±å‘Šæ›¸ã€ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ã®ä»•æ§˜æ›¸ã‚’ç­–å®šã—ã€Streamlit Cloudã§ã®é‹ç”¨ã‚’å‰æã¨ã—ãŸå …ç‰¢ã‹ã¤é«˜æ©Ÿèƒ½ãªå®Ÿè£…è¨­è¨ˆã‚’æä¾›ã—ã¾ã™ã€‚

ã”æç¤ºã„ãŸã ã„ãŸPDF  ã®æ§‹é€ ã‚’å®Œå…¨ã«æŠŠæ¡ã—ã€ç¾å ´ã®è·å“¡ãŒã€Œæ•°è¡Œã®ãƒ¡ãƒ¢ã€ã‚’å…¥åŠ›ã™ã‚‹ã ã‘ã§ã€AIï¼ˆGrokãƒ¢ãƒ‡ãƒ«ã‚’æƒ³å®šï¼‰ãŒé©åˆ‡ãªãƒ“ã‚¸ãƒã‚¹æ–‡æ›¸ï¼ˆäº‹æ•…å ±å‘Šæ›¸ï¼‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã€PDFåŒ–ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

---

# ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸ï¼šæ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹äº‹æ•…å ±å‘Šæ›¸ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  (J-ARGS)

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

* **ã‚·ã‚¹ãƒ†ãƒ å**: J-ARGS (Japanese Accident Report Generation System for Day Service)
* 
**ç›®çš„**: äº‹æ•…ç™ºç”Ÿæ™‚ã®è·å“¡ã®ç²¾ç¥çš„ãƒ»æ™‚é–“çš„è² æ‹…ã®è»½æ¸›ã€‚AIã«ã‚ˆã‚‹å®¢è¦³çš„ã‹ã¤é©åˆ‡ãªæ–‡ç« ä½œæˆæ”¯æ´ã¨ã€å®šå‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ  ã¸ã®å®Œå…¨ãªæº–æ‹ ã€‚


* **ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **: Streamlit Cloud (Python 3.11+)
* **ä¸»è¦æŠ€è¡“**: Streamlit (UI), ReportLab (PDF Engine), LangChain/OpenAI Client (AI Integration for Grok)

## 2. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦å‹•ä½œã—ã€ä»¥ä¸‹ã®3å±¤æ§‹é€ ã‚’æŒã¡ã¾ã™ã€‚

1. **Presentation Layer (Streamlit)**:
* ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆç™ºç”Ÿæ—¥æ™‚ã€å ´æ‰€ã€çŠ¶æ³ãƒ¡ãƒ¢ç­‰ï¼‰ã€‚
* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã€‚


2. **Logic Layer (Python)**:
* **AI Generator**: å…¥åŠ›ã•ã‚ŒãŸã€ŒçŠ¶æ³ãƒ¡ãƒ¢ã€ã‚’å…ƒã«ã€å ±å‘Šæ›¸ã«ãµã•ã‚ã—ã„ã€ŒçŠ¶æ³ã€ã€ŒçµŒéã€ã€ŒåŸå› ã€ã€Œå¯¾ç­–ã€ã®æ–‡ç« ã‚’æ§‹é€ åŒ–ã—ã¦ç”Ÿæˆã€‚
* 
**PDF Engine**: `reportlab` ã‚’ç”¨ã„ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸæ›¸å¼  ã‚’ãƒ”ã‚¯ã‚»ãƒ«å˜ä½ã§å†ç¾ã€‚




3. **Infrastructure Layer (Streamlit Cloud)**:
* GitHubé€£æºã«ã‚ˆã‚‹CI/CDã€‚
* Secrets Managementã«ã‚ˆã‚‹APIã‚­ãƒ¼ç®¡ç†ã€‚
* Linuxç’°å¢ƒä¸‹ã§ã®æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¯¾å¿œã€‚



## 3. æ©Ÿèƒ½è¦ä»¶ (Functional Requirements)

### 3.1 å…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä»¥ä¸‹ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

* 
**åŸºæœ¬æƒ…å ±**: äº‹æ¥­æ‰€å ã€å ±å‘Šè€…å ã€è¨˜éŒ²æ—¥ ã€‚


* 
**äº‹æ•…ç‰¹å®šæƒ…å ±**: ç™ºç”Ÿæ—¥æ™‚ï¼ˆå¹´/æœˆ/æ—¥/æ›œæ—¥/æ™‚/åˆ†ï¼‰ã€ç™ºç”Ÿå ´æ‰€ ã€å¯¾è±¡è€…ï¼ˆå…ç«¥åï¼‰ã€‚


* **AIã‚¢ã‚·ã‚¹ãƒˆå…¥åŠ› (Magic Field)**:
* ã€Œç®‡æ¡æ›¸ãã®ãƒ¡ãƒ¢ã€ã‚„ã€ŒéŸ³å£°å…¥åŠ›ã—ãŸã‚ˆã†ãªãƒ©ãƒ•ãªãƒ†ã‚­ã‚¹ãƒˆã€ã‚’å…¥åŠ›ã‚¨ãƒªã‚¢ã«è¨˜è¿°ã€‚
* ã€ŒAIã§å ±å‘Šæ›¸æ¡ˆã‚’ä½œæˆã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®4é …ç›®ã¸è‡ªå‹•å±•é–‹ãƒ»æ¨æ•²ã‚’è¡Œã†ã€‚


* 
**è©³ç´°è¨˜è¿°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:


1. äº‹æ•…ç™ºç”Ÿã®çŠ¶æ³
2. çµŒé
3. äº‹æ•…åŸå› 
4. å¯¾ç­–
5. ãã®ä»–



### 3.2 PDFç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³

* A4ç¸¦æ›¸ããƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã€‚
* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šäº‹æ¥­æ‰€åã€ã‚¿ã‚¤ãƒˆãƒ« ã€‚


* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ã‚ˆã‚‹æ—¥æ™‚ãƒ»å ´æ‰€ã®é…ç½®ã€‚
* ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼šå‹•çš„ãªè¡Œé«˜ã•èª¿æ•´ï¼ˆãƒ†ã‚­ã‚¹ãƒˆé‡ã«å¿œã˜ãŸè‡ªå‹•æŠ˜ã‚Šè¿”ã—ï¼‰ã€‚
* ãƒ•ãƒƒã‚¿ãƒ¼ï¼šç®¡ç†è€…å°æ ã€å ±å‘Šè€…ç½²åæ ã€ä¿è­·è€…ç¢ºèªæ¬„ ã€‚



### 3.3 ãƒ‡ãƒ—ãƒ­ã‚¤è¦ä»¶ (Streamlit Cloud)

* **æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆå¯¾å¿œ**: Linuxç’°å¢ƒï¼ˆDebian/Ubuntuï¼‰ã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ«å†…ã«ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`.ttf`ï¼‰ã‚’å«ã‚ã‚‹ã‹ã€Webãƒ•ã‚©ãƒ³ãƒˆã‚’å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã™ã‚‹ã€‚ä»Šå›ã¯ç¢ºå®Ÿæ€§ã‚’é‡è¦–ã—ã€`IPAexGothic` ç­‰ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ•ã‚©ãƒ³ãƒˆã‚’åŒæ¢±ã™ã‚‹è¨­è¨ˆã¨ã™ã‚‹ã€‚

---

## 4. å®Ÿè£…ã‚³ãƒ¼ãƒ‰ (Implementation)

ä»¥ä¸‹ã¯ã€ã“ã®ä»•æ§˜ã«åŸºã¥ã„ãŸå®Œå…¨ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç¾¤ã§ã™ã€‚

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```text
repo/
â”œâ”€â”€ app.py                  # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ (UI & Logic)
â”œâ”€â”€ pdf_generator.py        # PDFç”Ÿæˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (ReportLab)
â”œâ”€â”€ requirements.txt        # ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
â””â”€â”€ fonts/
    â””â”€â”€ IPAexGothic.ttf     # æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆ (IPAã‚µã‚¤ãƒˆç­‰ã‹ã‚‰é…ç½®ã™ã‚‹æƒ³å®š)

```

### 4.1 `requirements.txt`

Streamlit Cloudæ§‹ç¯‰ç”¨ã§ã™ã€‚

```text
streamlit
reportlab
openai
python-dateutil

```

### 4.2 `pdf_generator.py`

å‰å›ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ã—ã€ãƒ•ã‚©ãƒ³ãƒˆãƒ‘ã‚¹ã‚’å‹•çš„ã«è§£æ±ºã™ã‚‹ã‚ˆã†ã«æ”¹è‰¯ã—ã¾ã—ãŸã€‚

```python
import os
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib.units import mm
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.platypus import Table, TableStyle, Paragraph
from reportlab.lib.styles import getSampleStyleSheet
from reportlab.lib import colors

class AccidentReportGenerator:
    def __init__(self, font_path="fonts/IPAexGothic.ttf"):
        self.width, self.height = A4
        # ãƒ•ã‚©ãƒ³ãƒˆã®ç™»éŒ²ï¼ˆStreamlit Cloudå¯¾å¿œã®ãŸã‚TTFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥èª­ã¿è¾¼ã‚€ï¼‰
        self.font_name = "CustomJapaneseFont"
        
        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆæ–‡å­—åŒ–ã‘ã™ã‚‹ãŒã‚¨ãƒ©ãƒ¼ã¯é˜²ãï¼‰
        if os.path.exists(font_path):
            pdfmetrics.registerFont(TTFont(self.font_name, font_path))
        else:
            # é–‹ç™ºç’°å¢ƒç­‰ã§ãƒ•ã‚©ãƒ³ãƒˆãŒãªã„å ´åˆã®ç·Šæ€¥æªç½®
            try:
                from reportlab.pdfbase.cidfonts import UnicodeCIDFont
                pdfmetrics.registerFont(UnicodeCIDFont("HeiseiKakuGo-W5-Acro"))
                self.font_name = "HeiseiKakuGo-W5-Acro"
            except:
                self.font_name = "Helvetica" # æœ€çµ‚æ‰‹æ®µ

    def generate(self, data, output_path):
        c = canvas.Canvas(output_path, pagesize=A4)
        c.setTitle("äº‹æ•…çŠ¶æ³ãƒ»å¯¾ç­–å ±å‘Šæ›¸")

        # ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        FONT_SIZE_TITLE = 18
        FONT_SIZE_LABEL = 10
        FONT_SIZE_TEXT = 10

        # [cite_start]--- ã‚¿ã‚¤ãƒˆãƒ« [cite: 2] ---
        c.setFont(self.font_name, FONT_SIZE_TITLE)
        c.drawCentredString(self.width / 2, self.height - 20 * mm, "äº‹æ•…çŠ¶æ³ãƒ»å¯¾ç­–å ±å‘Šæ›¸")

        # [cite_start]--- äº‹æ¥­æ‰€å [cite: 1] ---
        y_pos = self.height - 40 * mm
        c.setFont(self.font_name, 11)
        c.drawString(20 * mm, y_pos, "ã€äº‹æ¥­æ‰€åã€‘")
        c.line(45 * mm, y_pos - 1 * mm, 120 * mm, y_pos - 1 * mm)
        c.drawString(45 * mm, y_pos, data.get("facility_name", ""))

        # [cite_start]--- åŸºæœ¬æƒ…å ±ã‚¨ãƒªã‚¢ [cite: 4, 12, 13] ---
        y_pos -= 12 * mm
        
        # 1è¡Œç›®: ç™ºç”Ÿæ—¥æ™‚
        c.setFont(self.font_name, FONT_SIZE_LABEL)
        c.drawString(20 * mm, y_pos, "äº‹æ•…ç™ºç”Ÿæ—¥æ™‚ï¼š")
        
        date_str = f"{data.get('year', '')} å¹´  {data.get('month', '')} æœˆ  {data.get('day', '')} æ—¥"
        time_str = f"{data.get('hour', '')} æ™‚  {data.get('minute', '')} åˆ†é ƒ"
        weekday = f"({data.get('weekday', '')})æ›œæ—¥"
        
        c.drawString(50 * mm, y_pos, f"{date_str}   {time_str}   {weekday}")

        # 2è¡Œç›®: å ´æ‰€ãƒ»å¯¾è±¡è€…
        y_pos -= 8 * mm
        c.drawString(20 * mm, y_pos, "ç™ºç”Ÿå ´æ‰€ï¼š")
        c.drawString(50 * mm, y_pos, data.get("location", ""))

        [cite_start]c.drawString(110 * mm, y_pos, "å¯¾è±¡è€…ï¼š") # [cite: 13]
        c.drawString(130 * mm, y_pos, data.get("subject", ""))

        # [cite_start]--- ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ« [cite: 6] ---
        # ReportLabã®Tableæ©Ÿèƒ½ã‚’ä½¿ç”¨
        
        # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æº–å‚™ï¼ˆè‡ªå‹•æ”¹è¡Œã®ãŸã‚ã«Paragraphã‚’ä½¿ç”¨ã™ã¹ãã ãŒã€ä»Šå›ã¯ç°¡æ˜“åŒ–ã®ãŸã‚Tableã®Wrapã‚’ä½¿ç”¨ï¼‰
        # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ParagraphStyleã‚’ä½¿ã£ã¦é•·æ–‡å¯¾å¿œã‚’å¼·åŒ–ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨
        
        headers = [
            ("äº‹æ•…ç™ºç”Ÿã®\nçŠ¶æ³", data.get("situation", "")),
            ("çµŒé", data.get("process", "")),
            ("äº‹æ•…åŸå› ", data.get("cause", "")),
            ("å¯¾ç­–", data.get("countermeasure", "")),
            ("ãã®ä»–", data.get("others", ""))
        ]

        table_data = []
        for title, content in headers:
            # æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’åæ˜ ã•ã›ã‚‹å‡¦ç†
            content_display = content if content else ""
            table_data.append([title, content_display])

        # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        t_style = [
            ('FONT', (0, 0), (-1, -1), self.font_name, 10),
            ('GRID', (0, 0), (-1, -1), 0.5, colors.black),
            ('VALIGN', (0, 0), (-1, -1), 'TOP'),
            ('ALIGN', (0, 0), (0, -1), 'CENTER'),
            ('ALIGN', (1, 0), (1, -1), 'LEFT'),
            ('LEFTPADDING', (0, 0), (-1, -1), 6),
            ('RIGHTPADDING', (0, 0), (-1, -1), 6),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
        ]

        # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆç®—
        col_widths = [30 * mm, 140 * mm]
        # è¡Œã®é«˜ã•ã¯å›ºå®šã§ã¯ãªãã€å†…å®¹é‡ã«å¿œã˜ã¦ã‚ã‚‹ç¨‹åº¦å¯å¤‰ã«ã—ãŸã„ãŒã€
        # æ›¸å¼ã®å†ç¾æ€§ã‚’é‡è¦–ã—ã¦å›ºå®šå€¤ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¤ã¤ã€å…¥åŠ›åˆ¶é™ã‚’UIå´ã§è¡Œã†ã®ãŒå®‰å…¨
        row_heights = [50 * mm, 30 * mm, 30 * mm, 40 * mm, 20 * mm]

        t = Table(table_data, colWidths=col_widths, rowHeights=row_heights)
        t.setStyle(TableStyle(t_style))
        
        # æç”»
        w, h = t.wrapOn(c, self.width, self.height)
        t.drawOn(c, 20 * mm, y_pos - h - 5 * mm)

        footer_base_y = y_pos - h - 5 * mm - 10 * mm

        # [cite_start]--- ç½²åãƒ»ç¢ºèªæ¬„ã‚¨ãƒªã‚¢ [cite: 7, 19, 20] ---
        
        # å³å´ã®ç®¡ç†è€…ãƒ»å ±å‘Šè€…æ 
        box_y = footer_base_y - 25 * mm
        
        # ç®¡ç†è€…
        c.rect(115 * mm, box_y, 25 * mm, 20 * mm)
        c.drawString(118 * mm, box_y + 16 * mm, "ç®¡ç†è€…")
        
        # å ±å‘Šè€…
        c.rect(145 * mm, box_y, 40 * mm, 20 * mm)
        c.drawString(147 * mm, box_y + 16 * mm, "å ±å‘Šè€…æ°å")
        c.drawString(150 * mm, box_y + 5 * mm, data.get("reporter", ""))

        # [cite_start]è¨˜éŒ²æ—¥ [cite: 9]
        c.drawString(145 * mm, box_y + 22 * mm, f"è¨˜éŒ²æ—¥: {data.get('record_date', '')}")

        # [cite_start]å·¦å´ã®ä¿è­·è€…èª¬æ˜æ¬„ [cite: 20]
        confirm_y = box_y - 35 * mm
        c.rect(20 * mm, confirm_y, 165 * mm, 30 * mm)
        
        c.setFont(self.font_name, 9)
        c.drawString(25 * mm, confirm_y + 25 * mm, "ä¸Šè¨˜ã«ã¤ã„ã¦ã€èª¬æ˜ã‚’å—ã‘ã¾ã—ãŸã€‚")
        c.drawString(110 * mm, confirm_y + 25 * mm, "(èª¬æ˜ãŒå¿…è¦ãªå ´åˆã«ç½²åãƒ»æºå°ã‚’é ‚ãã¾ã™)")
        
        c.setFont(self.font_name, 11)
        c.drawString(30 * mm, confirm_y + 8 * mm, "å¹´       æœˆ       æ—¥")
        c.drawString(90 * mm, confirm_y + 8 * mm, "æ°å")
        c.line(105 * mm, confirm_y + 8 * mm, 170 * mm, confirm_y + 8 * mm)

        c.save()
        return output_path

```

### 4.3 `app.py` (Streamlit Frontend & AI Integration)

ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ï¼ˆUXï¼‰ã‚’æœ€å¤§åŒ–ã™ã‚‹ãŸã‚ã€ç›´æ„Ÿçš„ãªUIã¨AIç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±åˆã—ã¾ã™ã€‚

```python
import streamlit as st
import datetime
import os
from pdf_generator import AccidentReportGenerator

# --- AI Integration Mockup ---
# Grok (via OpenAI compatible API or generic LLM call)
# å®Ÿéš›ã«ã¯ã“ã“ã« api_key=st.secrets["XAI_API_KEY"] ç­‰ã‚’ä½¿ç”¨
def generate_ai_draft(raw_text):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ©ãƒ•ãªãƒ¡ãƒ¢ã‹ã‚‰ã€å ±å‘Šæ›¸ã®å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã€‚
    å®Ÿé‹ç”¨ã§ã¯ openai.ChatCompletion ç­‰ã‚’ä½¿ç”¨ã—ã€system promptã§
    ã€Œã‚ãªãŸã¯ãƒ—ãƒ­ã®ä»‹è­·ãƒ»ä¿è‚²ç¾å ´ã®ç®¡ç†è€…ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ¡ãƒ¢ã‹ã‚‰äº‹æ•…å ±å‘Šæ›¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€ã¨æŒ‡ç¤ºã™ã‚‹ã€‚
    """
    # NOTE: ã“ã“ã«Grok/OpenAI APIå‘¼ã³å‡ºã—ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°
    # ä»Šå›ã¯ãƒ‡ãƒ¢å‹•ä½œã®ãŸã‚ã«ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¾ã™
    return {
        "situation": f"ï¼ˆAIç”Ÿæˆæ¡ˆï¼‰\n{raw_text}ã®çŠ¶æ³ã«ãŠã„ã¦ã€...\nè©³ç´°ãªçŠ¶æ³èª¬æ˜...",
        "process": "ï¼ˆAIç”Ÿæˆæ¡ˆï¼‰\nç›´ã¡ã«è·å“¡ãŒé§†ã‘ã¤ã‘ç¢ºèªã€‚\nä¿è­·è€…ã¸ã®é€£çµ¡ã‚’xxæ™‚xxåˆ†ã«å®Ÿæ–½...",
        "cause": "ï¼ˆAIç”Ÿæˆæ¡ˆï¼‰\nãƒ»ç’°å¢ƒè¦å› ï¼š...\nãƒ»äººçš„è¦å› ï¼š...",
        "countermeasure": "ï¼ˆAIç”Ÿæˆæ¡ˆï¼‰\nãƒ»å†ç™ºé˜²æ­¢ç­–ã¨ã—ã¦..."
    }

# --- Streamlit UI Configuration ---
st.set_page_config(page_title="äº‹æ•…å ±å‘Šæ›¸ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ", layout="wide")

st.title("ğŸ›¡ï¸ æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ äº‹æ•…å ±å‘Šæ›¸ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼")
[cite_start]st.markdown("å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨AIã‚¢ã‚·ã‚¹ãƒˆã‚’ç”¨ã„ã¦ã€å…¬å¼æ›¸å¼ [cite: 1] ã®PDFã‚’å³åº§ã«ä½œæˆã—ã¾ã™ã€‚")

# --- Sidebar: è¨­å®šãƒ»åŸºæœ¬æƒ…å ± ---
with st.sidebar:
    st.header("åŸºæœ¬è¨­å®š")
    facility_name = st.text_input("äº‹æ¥­æ‰€å", value="æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ ãƒŸãƒ©ã‚¤")
    reporter_name = st.text_input("å ±å‘Šè€…æ°å")
    record_date = st.date_input("è¨˜éŒ²æ—¥", datetime.date.today())

# --- Main Form ---
with st.form("report_form"):
    st.subheader("1. äº‹æ•…ç™ºç”Ÿæƒ…å ±")
    col1, col2, col3 = st.columns(3)
    with col1:
        accident_date = st.date_input("ç™ºç”Ÿæ—¥", datetime.date.today())
    with col2:
        accident_time = st.time_input("ç™ºç”Ÿæ™‚åˆ»", datetime.time(16, 30))
    with col3:
        weekday_map = {0: 'æœˆ', 1: 'ç«', 2: 'æ°´', 3: 'æœ¨', 4: 'é‡‘', 5: 'åœŸ', 6: 'æ—¥'}
        weekday_val = weekday_map[accident_date.weekday()]
        st.info(f"æ›œæ—¥ã¯è‡ªå‹•è¨­å®š: {weekday_val}æ›œæ—¥")

    col_loc, col_sub = st.columns([1, 1])
    with col_loc:
        [cite_start]location = st.text_input("ç™ºç”Ÿå ´æ‰€ [cite: 12]", placeholder="ä¾‹ï¼šãƒ—ãƒ¬ã‚¤ãƒ«ãƒ¼ãƒ ã€é€è¿è»Šå†…")
    with col_sub:
        [cite_start]subject = st.text_input("å¯¾è±¡è€…ï¼ˆå…ç«¥åï¼‰ [cite: 13]", placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ")

    st.markdown("---")
    st.subheader("2. è©³ç´°å†…å®¹ (AIã‚¢ã‚·ã‚¹ãƒˆæ©Ÿèƒ½)")
    
    # AIå…¥åŠ›ã‚¨ãƒªã‚¢
    ai_input = st.text_area("ã“ã“ã«ã€Œä½•ãŒèµ·ããŸã‹ã€ã‚’ç®‡æ¡æ›¸ãã‚„ãƒ¡ãƒ¢æ›¸ãã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", height=100,
                           placeholder="ä¾‹ï¼šãƒãƒ©ãƒ³ã‚¹ãƒœãƒ¼ãƒ«ã§éŠã‚“ã§ã„ã¦è»¢ã‚“ã ã€‚æ‰‹é¦–ã‚’ç—›ãŒã£ãŸã®ã§å†·ã‚„ã—ãŸã€‚ãŠæ¯ã•ã‚“ã«é›»è©±ã—ã¦èª¬æ˜ã—ãŸã€‚")
    
    use_ai = st.checkbox("AIã§æ–‡ç« ã‚’æ•´å½¢ãƒ»ç”Ÿæˆã™ã‚‹")
    
    # æ‰‹å‹•ä¿®æ­£ãƒ»ç¢ºèªç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    # AIä½¿ç”¨æ™‚ã¯ã“ã“ã‚’è‡ªå‹•å…¥åŠ›ã€ãã†ã§ãªã‘ã‚Œã°æ‰‹å…¥åŠ›
    
    col_main_1, col_main_2 = st.columns(2)
    
    with col_main_1:
        [cite_start]situation = st.text_area("äº‹æ•…ç™ºç”Ÿã®çŠ¶æ³ [cite: 6]", height=150)
        [cite_start]cause = st.text_area("äº‹æ•…åŸå›  [cite: 6]", height=120)
        [cite_start]others = st.text_area("ãã®ä»– [cite: 6]", height=80)
        
    with col_main_2:
        [cite_start]process = st.text_area("çµŒé [cite: 6]", height=150)
        [cite_start]countermeasure = st.text_area("å¯¾ç­– [cite: 6]", height=120)

    # ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒœã‚¿ãƒ³ï¼ˆã“ã‚Œã¯ç”Ÿæˆãƒˆãƒªã‚¬ãƒ¼ã§ã¯ãªã„ï¼‰
    submitted = st.form_submit_button("å…¥åŠ›å†…å®¹ã‚’ç¢ºå®š")

# --- Logic Handling ---
if submitted:
    # ãƒ‡ãƒ¼ã‚¿ã®è¾æ›¸åŒ–
    data = {
        "facility_name": facility_name,
        "year": str(accident_date.year),
        "month": str(accident_date.month),
        "day": str(accident_date.day),
        "weekday": weekday_val,
        "hour": str(accident_time.hour),
        "minute": f"{accident_time.minute:02d}",
        "location": location,
        "subject": subject,
        "situation": situation,
        "process": process,
        "cause": cause,
        "countermeasure": countermeasure,
        "others": others,
        "reporter": reporter_name,
        "record_date": record_date.strftime("%Yå¹´%mæœˆ%dæ—¥")
    }
    
    # AIç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®æ³¨å…¥ï¼ˆãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆï¼‰
    if use_ai and ai_input:
        with st.spinner("AIãŒå ±å‘Šæ›¸ã‚’ä½œæˆä¸­..."):
            ai_draft = generate_ai_draft(ai_input)
            # ã“ã“ã§ä¸Šæ›¸ãå‡¦ç†ï¼ˆå®Ÿéš›ã«ã¯session_stateã‚’ä½¿ã£ã¦UIã«åæ˜ ã•ã›ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã ãŒã€
            # PDFç”Ÿæˆç”¨ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã¯ã“ã“ã§ãƒãƒ¼ã‚¸ã™ã‚‹ï¼‰
            if not situation: data["situation"] = ai_draft["situation"]
            if not process: data["process"] = ai_draft["process"]
            if not cause: data["cause"] = ai_draft["cause"]
            if not countermeasure: data["countermeasure"] = ai_draft["countermeasure"]

    # PDFç”Ÿæˆ
    output_filename = "accident_report.pdf"
    
    # ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆStreamlit Cloudä¸Šã®ãƒ‘ã‚¹æ§‹æˆã«åˆã‚ã›ã‚‹ï¼‰
    font_path = "fonts/IPAexGothic.ttf" 
    
    generator = AccidentReportGenerator(font_path=font_path)
    generator.generate(data, output_filename)
    
    st.success("PDFã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼")
    
    # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
    with open(output_filename, "rb") as pdf_file:
        PDFbyte = pdf_file.read()
        
    st.download_button(label="ğŸ“„ å ±å‘Šæ›¸PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                       data=PDFbyte,
                       file_name=f"äº‹æ•…å ±å‘Šæ›¸_{accident_date}.pdf",
                       mime='application/pdf')

    # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆiframeä½¿ç”¨ï¼‰
    import base64
    base64_pdf = base64.b64encode(PDFbyte).decode('utf-8')
    pdf_display = f'<iframe src="data:application/pdf;base64,{base64_pdf}" width="100%" height="800" type="application/pdf"></iframe>'
    st.markdown(pdf_display, unsafe_allow_html=True)


```

---

## 5. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é † (Ultrahard Execution Plan)

Streamlit Cloudã§å‹•ä½œã•ã›ã‚‹ãŸã‚ã®å…·ä½“çš„ãªæ‰‹é †ã§ã™ã€‚ã“ã“ã§ã®å¤±æ•—ãƒã‚¤ãƒ³ãƒˆã¯ã€Œæ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã®æ¬ è½ã€ã§ã™ã€‚ã“ã‚Œã‚’é˜²ãæ‰‹é †ã‚’å«ã¿ã¾ã™ã€‚

1. **ãƒªãƒã‚¸ãƒˆãƒªã®æº–å‚™**:
* GitHubã«æ–°è¦ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã€‚
* ä¸Šè¨˜ã® `app.py`, `pdf_generator.py`, `requirements.txt` ã‚’é…ç½®ã€‚
* **é‡è¦**: `fonts` ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã§å†é…å¸ƒå¯èƒ½ãªæ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆï¼ˆä¾‹: `IPAexGothic.ttf`ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦é…ç½®ã—ã€ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã€‚ã“ã‚ŒãŒãªã„ã¨æœ¬ç•ªç’°å¢ƒã§æ–‡å­—åŒ–ã‘ã—ã¾ã™ã€‚


2. **Streamlit Cloudè¨­å®š**:
* Streamlit Cloudã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ä½œæˆã—ãŸGitHubãƒªãƒã‚¸ãƒˆãƒªã‚’é€£æºã€‚
* Main file pathã« `app.py` ã‚’æŒ‡å®šã€‚
* **Advanced settings** ã«ã¦ã€Pythonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ `3.9` ã¾ãŸã¯ `3.11` ã«æŒ‡å®šã€‚


3. **Secretsã®è¨­å®š (AIæ©Ÿèƒ½ç”¨)**:
* Settings -> Secrets ã«ã¦APIã‚­ãƒ¼ã‚’è¨­å®šã€‚
```toml
XAI_API_KEY = "your-grok-api-key"

```





ã“ã‚Œã§ã€ä¸–ç•Œä¸­ã©ã“ã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå“è³ªã®äº‹æ•…å ±å‘Šæ›¸ã‚’ä½œæˆã§ãã‚‹ã‚·ã‚¹ãƒ†ãƒ ãŒç¨¼åƒã—ã¾ã™ã€‚

ãƒˆãƒƒãƒ—ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ã¨ã—ã¦ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ã™ãŒã€AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ`system prompt`ï¼‰ã®èª¿æ•´ãŒã€å‡ºåŠ›ã•ã‚Œã‚‹å ±å‘Šæ›¸ã®ã€Œè³ªï¼ˆè¡Œæ”¿æ–‡æ›¸ã‚‰ã—ã•ï¼‰ã€ã‚’å·¦å³ã—ã¾ã™ã€‚ã€Œå®¢è¦³çš„è¨˜è¿°ã€ã€Œæ„Ÿæƒ…èªã®æ’é™¤ã€ã€Œ5W1Hã®å¾¹åº•ã€ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã‚‹ã‚ˆã†ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¦ãã ã•ã„ã€‚

ãƒªãƒã‚¸ãƒˆãƒªä½œæˆã‹ã‚‰ãŠæ‰‹ä¼ã„ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ